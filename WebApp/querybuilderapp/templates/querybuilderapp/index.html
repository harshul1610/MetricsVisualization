{% load static %}
<!DOCTYPE html>

<head>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.query-builder/2.3.3/js/query-builder.standalone.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script src="https://unpkg.com/multiple-select@1.3.1/dist/multiple-select.min.js"></script>
		
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.query-builder/2.3.3/css/query-builder.default.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://unpkg.com/multiple-select@1.3.1/dist/multiple-select.min.css">
		<title>QueryBuilder</title>

		<style>
			h1 { color: #111; font-size: 80px; font-family: 'Helvetica Neue', 'sans-serif'; font-weight: bold; letter-spacing: -1px; line-height: 1; text-align: center; }
			#forkongithub a{background:green;color:#fff;text-decoration:none;font-family:inherit,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}#forkongithub a:hover{background:#0b6623;color:#fff;}#forkongithub a::before,#forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}#forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:800px){#forkongithub{position:absolute;display:block;top:0;right:0;width:200px;overflow:hidden;height:200px;z-index:9999;}#forkongithub a{width:200px;position:absolute;top:40px;right:-50px;transform:rotate(45deg);-webkit-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-o-transform:rotate(45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}
			
			</style>
</head>

<body>
		<h1>Django-QueryBuilder</h1>
		<span id="forkongithub"><a href="https://github.com/harshul1610/MetricsVisualization">Fork me on GitHub</a></span>
		

		<div style="padding-top: 50px; margin:50px;">
				<!-- DB Table -->
				<div class="row">
							<div class="col-sm-3">
									<label>Table: </label>
									<div id="dbtable" class="dropdown">
											
											<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
												Select Table
											<span class="caret"></span>
											</button>
											<ul class="dropdown-menu" aria-labelledby="dbtable">
												{% for table in tables %}
												<li><a href="#">{{table}}</a></li>
												{% endfor %}
											</ul>
									</div>
							</div>

							<div class="col-sm-3">
								<!-- Aggregation input -->
								<label>Aggregation: </label>
								<div id="aggregationtype" class="dropdown">
												
									<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
												Select Aggregation
												<span class="caret"></span>
												</button>
												<ul class="dropdown-menu" aria-labelledby="aggregationtype">
													<li><a href="#">None</a></li>
													<li><a href="#">Sum</a></li>
													<li><a href="#">Count</a></li>
												</ul>
								</div>
							</div>

							<!-- Table Columns -->
							<div class="col-sm-3">
								<label id="columnslabel" >Columns:</label>
								<div id="tablecolumns">
									<select multiple="multiple" name="tablecolumns" id="tablecolumnslist" style="width: 200px;">
									</select>
								</div>
							</div>
							

						</div>

					<div class="row">
						<div class="col">
							<div style="margin: 15px;" id="builder"></div>
						</div>
					</div>

					<div id="querybuilderbuttons" style="display:none;" class="row">
						  <div style="margin-left:15px">
								<button class="btn btn-success" id="btn-set">Set Rules</button>
								<button class="btn btn-primary" id="btn-get">Get Rules</button>
								<button class="btn btn-warning" id="btn-reset">Reset</button>
								<button class="btn btn-success" id="btn-sql">Get SQL</button>
						  </div>
					</div>
				
				</div>
		</div>

		<script>
		$('#tablecolumnslist').multipleSelect();
		
		// handling table dropdown
		$("#dbtable li a").click(function(){
			$(this).parents("#dbtable").find('.btn').html($(this).text() + ' <span class="caret"></span>');
			$(this).parents("#dbtable").find('.btn').val($(this).data('value'));
			var table_name = $(this).text();

					// ajax for getting the column names.
					$.ajax({
						url: 'getschemadetails',
						type: "POST",
						dataType: "json",
						data: {
							'table_name': table_name,
							'csrfmiddlewaretoken': '{{ csrf_token }}'
						},
						success: function (result) {
							// populate the columns list
							var list = document.getElementById("tablecolumnslist");
							list.innerHTML='';
							for (var i = 0; i < result.length; i++){                
									var opt = result[i][0];
									var option = document.createElement("option");
									option.value = opt;           
									var text = document.createTextNode(opt);
									option.appendChild(text);
									list.appendChild(option);
								};
							$('#tablecolumnslist').multipleSelect();

							//populate the filter paramters
							var filters_= [];
							var field_map = {
								'AutoField': 'integer',
								'TextField': 'string',
								'FloatField': 'double',
								'IntegerField': 'integer',
								'DateTimeField': 'datetime',
							}
							for (var i = 0; i < result.length; i++){                
									var col = result[i][0];
									var col_type = field_map[result[i][1]];
									var filter_ = {
										id: col,
										label: col,
										type: col_type,
									}
									filters_.push(filter_)
								};
							// handling the querybuilder
							$('#builder').queryBuilder({
							plugins: ['bt-tooltip-errors'],
							filters: filters_
							});
							$('#querybuilderbuttons').css('display', 'block');

						}
					});

			});

		// handling aggregation dropdown
		$("#aggregationtype li a").click(function(){
			$(this).parents("#aggregationtype").find('.btn').html($(this).text() + ' <span class="caret"></span>');
			$(this).parents("#aggregationtype").find('.btn').val($(this).data('value'));
			var aggregation_type = $(this).text();
			
			// handle columns based on aggregation
			if (aggregation_type === "None") {
				var columns_div = document.getElementById("columnslabel");
				columns_div.innerHTML = "X axis, Yaxis:";
			}
			else {
				var columns_div = document.getElementById("columnslabel");
				columns_div.innerHTML = "Groupby Columns:";
			}
			console.log(aggregation_type);
		});

		
	  /*filters: [{
	    id: 'name',
	    label: 'Name',
	    type: 'string'
	  }, {
	    id: 'category',
	    label: 'Category',
	    type: 'integer',
	    input: 'select',
	    values: {
	      1: 'Books',
	      2: 'Movies',
	      3: 'Music',
	      4: 'Tools',
	      5: 'Goodies',
	      6: 'Clothes'
	    },
	    operators: ['equal', 'not_equal', 'in', 'not_in', 'is_null', 'is_not_null']
	  }, {
	    id: 'in_stock',
	    label: 'In stock',
	    type: 'integer',
	    input: 'radio',
	    values: {
	      1: 'Yes',
	      0: 'No'
	    },
	    operators: ['equal']
	  }, {
	    id: 'price',
	    label: 'Price',
	    type: 'double',
	    validation: {
	      min: 0,
	      step: 0.01
	    }
	  }, {
	    id: 'id',
	    label: 'Identifier',
	    type: 'string',
	    placeholder: '____-____-____',
	    operators: ['equal', 'not_equal'],
	    validation: {
	      format: /^.{4}-.{4}-.{4}$/
	    }
	  }],*/

 /****************************************************************
    						Triggers and Changers QueryBuilder
 *****************************************************************/

	$('#btn-get').on('click', function() {
	  var result = $('#builder').queryBuilder('getRules');
		alert(JSON.stringify(result, null, 2));
	  /*if (!$.isEmptyObject(result)) {
	    alert(JSON.stringify(result, null, 2));
	  }
	  else{
	  	console.log("invalid object :");
	  }
	  console.log(result);
		*/
	});

	$('#btn-sql').on('click', function() {
	  var result = $('#builder').queryBuilder('getSQL');
		alert(JSON.stringify(result, null, 2));
	});


	$('#btn-reset').on('click', function() {
	  $('#builder').queryBuilder('reset');
	});

	$('#btn-set').on('click', function() {
	  //$('#builder').queryBuilder('setRules', rules_basic);
	  var result = $('#builder').queryBuilder('getRules');
	  if (!$.isEmptyObject(result)) {
	  	rules_basic = result;
	  }
	});

	//When rules changed :
	$('#builder').on('getRules.queryBuilder.filter', function(e) {
		//$log.info(e.value);
	});

  </script>
</body>
</html>